name: Bilibili增强
description: 拜托，没有广告的哔哩哔哩真的超酷的
compat_arguments:
  动态最常访问: auto
  创作中心: '0'
  过滤置顶评论广告: '1'
  空降助手: bilibili.airborne
  替换鉴权字段: '#'
  Authorization: identify_v1 xxx
compat_arguments_desc: '动态最常访问: [true, false, auto]\n- true: 始终显示\n- false: 始终隐藏\n- auto: 仅当列表中存在直播状态时显示\n\n创作中心: [1, 0]\n- 1: 显示\n- 0: 隐藏\n\n过滤置顶评论广告: [1, 0]\n- 1: 开启\n- 0: 关闭\n\n空降助手(beta): 默认开启，配置为"#"时关闭\n\n替换鉴权字段: 默认关闭，配置为"h"时开启，需填写Authorization'

rules:
- domain:
    match: api.biliapi.com
    policy: REJECT
- domain:
    match: app.biliapi.com
    policy: REJECT
- domain:
    match: api.biliapi.net
    policy: REJECT
- domain:
    match: app.biliapi.net
    policy: REJECT
map_locals:
- match: ^https:\/\/ap[ip]\.bilibili\.com\/x\/(?:resource\/(?:top\/activity|patch\/tab)|v2\/search\/square|vip\/ads\/materials)\?
  headers:
    content-type: ' application/json; charset=utf-8'
    bili-status-code: ' -404'
  body: '{"code":-404,"message":"-404","ttl":1,"data":null}'
- match: ^https:\/\/api\.bilibili\.com\/pgc\/activity\/deliver\/material\/receive\?
  headers:
    content-type: ' application/json'
    bili-status-code: ' 0'
  body: '{"code":0,"data":{"closeType":"close_win","container":[],"showTime":""},"message":"success"}'
- match: ^https:\/\/api\.live\.bilibili\.com\/xlive\/e-commerce-interface\/v1\/ecommerce-user\/get_shopping_info\?
  headers:
    content-type: ' application/json'
  body: '{}'

- http_request:
    name: 替换鉴权字段
    match: ^https:\/\/(?:grpc\.biliapi\.net|app\.bilibili\.com)\/bilibili\.app\.(?:playerunite\.v1\.Player\/PlayViewUnite|pgc\.gateway\.player\.v2\.PlayURL\/PlayView)$
    headers:
      Authorization: "{{{Authorization}}}"

body_rewrites:
- response_jq:
    match: ^https:\/\/api\.bilibili\.com\/pgc\/view\/v2\/app\/season\?
    filter: del(.data.payment)
- response_jq:
    match: ^https:\/\/api\.bilibili\.com\/pgc\/page\/(?:bangumi|cinema\/tab)\?
    filter: .result.modules |= if . then map(if (.style | startswith("tip")) or (.module_id | IN(241, 1283, 1441, 1284)) then .items = [] elif .style | startswith("banner") then .items |= if . then map(select(.link | contains("play"))) else [] end elif .style | startswith("function") then .items |= if . then map(select(.blink | startswith("bilibili"))) else [] end end) end
- response_jq:
    match: ^https:\/\/api\.live\.bilibili\.com\/xlive\/(?:app-interface\/v2\/index\/feed|app-room\/v1\/index\/getInfoBy(?:Room|User))\?
    filter: .data |= (del(.play_together_info, .play_together_info_v2, .activity_banner_info) | if .function_card then .function_card[] = null end | if .new_tab_info.outer_list then .new_tab_info.outer_list |= map(select(.biz_id != 33)) end | if .card_list then .card_list |= map(select(.card_type != "banner_v2")) end | reduce ([["show_reserve_status"], false], [["reserve_info", "show_reserve_status"], false], [["shopping_info", "is_show"], 0]) as [$path, $value] (.; if getpath($path) then setpath($path; $value) end))

- http_request:
    name: 空降助手
    match: ^https:\/\/(?:grpc\.biliapi\.net|app\.bilibili\.com)\/bilibili\.app\.playerunite\.v1\.Player\/PlayViewUnite$
    script_url: https://raw.githubusercontent.com/kokoryh/Sparkle/refs/heads/master/dist/bilibili.airborne.js
    arguments:
      _compat.$argument: '{"enableAirborne":"{{{空降助手}}}"}'
    body_required: true
    binary_body: true

- http_response:
    name: bilibili.skin
    match: ^https:\/\/app\.bilibili\.com\/x\/resource\/show\/skin\?
    script_url: https://raw.githubusercontent.com/kokoryh/Script/master/js/bili-suit-diy.js
    body_required: true

- http_response:
    name: bilibili.json
    match: ^https:\/\/app\.bilibili\.com\/x\/(?:resource\/show\/tab\/v2|v2\/(?:splash\/(?:list|show|event\/list2)|feed\/index(?:\/story)?|account\/(?:mine(?:\/ipad)?|myinfo))\?
    script_url: https://raw.githubusercontent.com/kokoryh/Sparkle/refs/heads/master/dist/bilibili.json.js
    arguments:
      _compat.$argument: '{"showUperCenter":"{{{创作中心}}}"}'
    body_required: true

- http_response:
    name: bilibili.dynAll
    match: ^https:\/\/(?:grpc\.biliapi\.net|app\.bilibili\.com)\/bilibili\.app\.dynamic\.v2\.Dynamic\/DynAll$
    script_url: https://raw.githubusercontent.com/kokoryh/Script/master/js/bilibili.protobuf.js
    arguments:
      _compat.$argument: '{"showUpList":"{{{动态最常访问}}}"}'
    body_required: true
    binary_body: true

- http_response:
    name: bilibili.playurl
    match: ^https:\/\/(?:grpc\.biliapi\.net|app\.bilibili\.com)\/bilibili\.app\.playurl\.v1\.PlayURL\/PlayView$
    script_url: https://raw.githubusercontent.com/kokoryh/Sparkle/refs/heads/master/dist/bilibili.protobuf.js
    arguments:
      _compat.$argument: '{"filterTopReplies":{{{过滤置顶评论广告}}}'
    body_required: true
    binary_body: true

- http_response:
    name: bilibili.playview_unite
    match: ^https:\/\/(?:grpc\.biliapi\.net|app\.bilibili\.com)\/bilibili\.app\.playerunite\.v1\.Player\/PlayViewUnite$
    script_url: https://raw.githubusercontent.com/kokoryh/Sparkle/refs/heads/master/dist/bilibili.protobuf.js
    body_required: true
    binary_body: true

mitm:
  hostnames:
    includes:
    - grpc.biliapi.net
    - app.bilibili.com
    - api.bilibili.com
    - api.live.bilibili.com